<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <title>MASTER - Controlo AGO</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg: #1a202c;
            --card: #2d3748;
            --text: #ffffff;
            --green: #48bb78;
            --red: #f56565;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 40px; display: flex; justify-content: center; }
        .panel { width: 100%; max-width: 450px; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; border-bottom: 2px solid #4a5568; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #4a5568; }
        .label { font-weight: 600; }
        .btn-group { display: flex; gap: 10px; }
        button { border: none; padding: 12px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; transition: 0.2s; color: white; min-width: 60px; }
        .btn-on { background: var(--green); }
        .btn-off { background: var(--red); }
        button:hover { opacity: 0.8; transform: scale(1.05); }
        button:active { transform: scale(0.95); }
        
        #status { margin-top: 25px; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 0.9rem; display: none; }
        .loading { background: #ecc94b; color: black; }
        .success { background: var(--green); }
        .error { background: var(--red); }
		
		button { 
        border: 2px solid transparent; 
        padding: 10px 18px; 
        cursor: pointer; 
        font-weight: bold; 
        border-radius: 6px; 
        transition: 0.2s; 
        color: white; 
        min-width: 80px;
        opacity: 0.4; /* Botões ficam baços por padrão */
    }
    
    /* Quando o botão está ativo (reflete o estado real do JSON) */
    button.active { 
        opacity: 1; 
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(255,255,255,0.2);
        border-color: white;
    }

    .btn-on { background: #48bb78; }
    .btn-off { background: #f56565; }
    </style>
</head>
<body>

<div class="panel">
    <h2><span class="material-icons">settings_remote</span> Administração: Controlo de Votos</h2>
    <div id="controls"></div>
    <div id="status"></div>
</div>

<script>
    // ============================================================
    // CONFIGURAÇÃO DIRETA - PREENCHA AQUI:
    // ============================================================
    const GITHUB_TOKEN = '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'; 
    const REPO_PATH = 'amaralcm/CSJBRJCP'; 
    const FILE_NAME = 'Formularios AGO20260226 votos.json';
    // ============================================================

   const pontos = {
        "presenca": "Presença", "ponto1": "Ponto 1", "ponto3": "Ponto 3",
        "ponto4": "Ponto 4", "ponto5": "Ponto 5", "ponto7": "Ponto 7", "ponto8": "Ponto 8"
    };

    // 1. Criar os botões na página
    const container = document.getElementById('controls');
    Object.keys(pontos).forEach(key => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
            <span class="label">${pontos[key]}</span>
            <div class="btn-group">
                <button id="btn-${key}-1" class="btn-on" onclick="updateGitHub('${key}', 1)">ABERTO</button>
                <button id="btn-${key}-0" class="btn-off" onclick="updateGitHub('${key}', 0)">FECHADO</button>
            </div>
        `;
        container.appendChild(row);
    });

    // 2. Função para ler o estado atual do GitHub e pintar os botões
    async function carregarEstadoAtual() {
        try {
            const url = `https://api.github.com/repos/${REPO_PATH}/contents/${FILE_NAME}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
            if (!res.ok) return;
            
            const data = await res.json();
            const currentContent = JSON.parse(atob(data.content));

            // Para cada ponto no JSON, marcar o botão correspondente como ativo
            Object.keys(currentContent).forEach(key => {
                const valor = currentContent[key];
                // Remove 'active' de ambos os botões do ponto
                document.getElementById(`btn-${key}-1`)?.classList.remove('active');
                document.getElementById(`btn-${key}-0`)?.classList.remove('active');
                
                // Adiciona 'active' ao botão que corresponde ao valor (0 ou 1)
                document.getElementById(`btn-${key}-${valor}`)?.classList.add('active');
            });
        } catch (e) { console.error("Erro ao ler estado inicial", e); }
    }

    // 3. Função para atualizar (modificada para repintar os botões após sucesso)
    async function updateGitHub(key, val) {
        const statusDiv = document.getElementById('status');
        statusDiv.style.display = "block";
        statusDiv.className = "loading";
        statusDiv.innerText = "A atualizar GitHub...";

        try {
            const url = `https://api.github.com/repos/${REPO_PATH}/contents/${FILE_NAME}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
            const data = await res.json();
            const currentContent = JSON.parse(atob(data.content));

            currentContent[key] = val;

            const putRes = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `AGO: ${key} -> ${val}`,
                    content: btoa(JSON.stringify(currentContent, null, 2)),
                    sha: data.sha
                })
            });

            if (putRes.ok) {
                statusDiv.className = "success";
                statusDiv.innerText = "Atualizado!";
                // Atualiza visualmente os botões
                carregarEstadoAtual();
                setTimeout(() => { statusDiv.style.display = "none"; }, 1500);
            }
        } catch (err) {
            statusDiv.className = "error";
            statusDiv.innerText = "Erro ao gravar.";
        }
    }

    // Executa ao abrir a página para mostrar como estão os botões agora
    carregarEstadoAtual();
</script>
</body>

</html>
